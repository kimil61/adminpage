<!-- templates/order/success.html -->
{% extends "base.html" %}

{% block title %}ê²°ì œ ì™„ë£Œ - My Website{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md text-center">
        <!-- ì„±ê³µ ì•„ì´ì½˜ -->
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        
        <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ‰ ê²°ì œ ì™„ë£Œ!</h1>
        <p class="text-gray-600 mb-6">AI ì‚¬ì£¼ ë¦¬í¬íŠ¸ êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        
        <!-- ì£¼ë¬¸ ì •ë³´ (ê°„ì†Œí™”) -->
        <div class="bg-blue-50 rounded-lg p-4 mb-6">
            <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">ì£¼ë¬¸ë²ˆí˜¸:</span>
                    <span class="font-semibold">#{{ order.id }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">ê¸ˆì•¡:</span>
                    <span class="font-semibold text-blue-600">{{ "{:,}".format(order.amount) }}ì›</span>
                </div>
            </div>
        </div>
        
        <!-- ë¦¬í¬íŠ¸ ìƒì„± ì•ˆë‚´ -->
        <div class="bg-purple-50 rounded-lg p-4 mb-6">
            <p class="text-purple-700 text-sm mb-2">ğŸ¤– AI ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...</p>
            <div class="w-full bg-purple-200 rounded-full h-2">
                <div class="bg-purple-600 h-2 rounded-full animate-pulse" style="width: 30%"></div>
            </div>
            <p class="text-xs text-purple-600 mt-2">ì™„ë£Œê¹Œì§€ 2-3ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.</p>
        </div>
        
        <!-- ìë™ ë‹«ê¸° ì•ˆë‚´ -->
        <div class="bg-gray-50 rounded-lg p-3 mb-4">
            <p class="text-sm text-gray-600">
                <span id="countdown">5</span>ì´ˆ í›„ ìë™ìœ¼ë¡œ ì°½ì´ ë‹«í™ë‹ˆë‹¤.
            </p>
        </div>
        
        <!-- ë²„íŠ¼ë“¤ -->
        <div class="space-y-2">
            <button onclick="goToMyPage()" 
                    class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ê¸°
            </button>
            <button onclick="closeWindow()" 
                    class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition duration-200">
                ì°½ ë‹«ê¸°
            </button>
        </div>
    </div>
</div>

<script>
let countdownTimer = 5;

// ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
const countdownInterval = setInterval(() => {
    countdownTimer--;
    document.getElementById('countdown').textContent = countdownTimer;
    
    if (countdownTimer <= 0) {
        clearInterval(countdownInterval);
        closeWindow();
    }
}, 1000);

// ì°½ ë‹«ê¸° í•¨ìˆ˜
function closeWindow() {
    try {
        // ë¶€ëª¨ ì°½ì´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
        if (window.opener && !window.opener.closed) {
            window.opener.location.href = '/order/mypage';
        }
        
        // íŒì—…ì°½ ë‹«ê¸°
        window.close();
        
        // window.close()ê°€ ì‘ë™í•˜ì§€ ì•ŠëŠ” ê²½ìš° (ì¼ë¶€ ë¸Œë¼ìš°ì €)
        setTimeout(() => {
            if (!window.closed) {
                alert('ì°½ì„ ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì„¸ìš”.');
            }
        }, 100);
        
    } catch (error) {
        console.error('ì°½ ë‹«ê¸° ì‹¤íŒ¨:', error);
        alert('ì°½ì„ ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì„¸ìš”.');
    }
}

// ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
function goToMyPage() {
    try {
        if (window.opener && !window.opener.closed) {
            // ë¶€ëª¨ ì°½ì—ì„œ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
            window.opener.location.href = '/order/mypage';
            // íŒì—… ë‹«ê¸°
            window.close();
        } else {
            // ë¶€ëª¨ ì°½ì´ ì—†ìœ¼ë©´ í˜„ì¬ ì°½ì—ì„œ ì´ë™
            window.location.href = '/order/mypage';
        }
    } catch (error) {
        console.error('í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨:', error);
        window.location.href = '/order/mypage';
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ íŒì—… í¬ê¸° ì¡°ì •
window.onload = function() {
    // íŒì—… ì°½ í¬ê¸° ì¡°ì • (ì„ íƒì‚¬í•­)
    if (window.resizeTo) {
        window.resizeTo(450, 600);
    }
};

// í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ESCë¡œ ë‹«ê¸°)
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeWindow();
    }
});

// 5ì´ˆë§ˆë‹¤ ë¦¬í¬íŠ¸ ìƒíƒœ í™•ì¸ (ë°±ê·¸ë¼ìš´ë“œ)
let statusCheckCount = 0;
const statusCheckInterval = setInterval(async () => {
    statusCheckCount++;
    
    // ìµœëŒ€ 20ë²ˆë§Œ ì²´í¬ (100ì´ˆ)
    if (statusCheckCount > 20) {
        clearInterval(statusCheckInterval);
        return;
    }
    
    try {
        const response = await fetch(`/order/status/{{ order.id }}`);
        const data = await response.json();
        
        if (data.report_status === 'completed') {
            clearInterval(statusCheckInterval);
            
            // ì™„ë£Œ ì•Œë¦¼
            const successAlert = document.createElement('div');
            successAlert.className = 'fixed top-4 left-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg z-50';
            successAlert.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="font-semibold">ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!</span>
                </div>
            `;
            document.body.appendChild(successAlert);
            
            // 3ì´ˆ í›„ ì•Œë¦¼ ì œê±°
            setTimeout(() => successAlert.remove(), 3000);
        }
    } catch (error) {
        console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
    }
}, 5000);
</script>
{% endblock %}