{% extends "base.html" %}

{% block title %}결제 처리 중 - My Website{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto text-center py-20">
    <div class="mb-8">
        <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-700 rounded-full animate-spin mx-auto"></div>
    </div>
    
    <h1 class="text-3xl font-bold text-purple-800 mb-4">🎉 결제가 완료되었습니다!</h1>
    
    <div class="bg-purple-50 p-6 rounded-xl mb-8">
        <h2 class="text-xl font-semibold mb-4">AI 심층 리포트 생성 중...</h2>
        <p class="text-gray-700 mb-4">
            고품질 리포트를 준비하고 있습니다.<br>
            완료되면 이메일로 발송됩니다. (약 2-3분 소요)
        </p>
        
        <div class="text-sm text-gray-600">
            <p>✅ 결제 완료</p>
            <p id="reportStatus">🔄 리포트 생성 중...</p>
            <p id="emailStatus">⏳ 이메일 발송 대기 중</p>
        </div>
    </div>
    
    <div class="space-y-4">
        <a href="/order/mypage" class="inline-block bg-purple-700 text-white px-6 py-3 rounded-lg hover:bg-purple-600">
            구매 내역 확인
        </a>
        <br>
        <a href="/saju/page1" class="inline-block text-purple-700 hover:underline">
            새로운 사주 보기
        </a>
    </div>
</div>

<script>
// 주문 상태 체크 (5초마다)
let checkCount = 0;
const maxChecks = 24; // 2분 (5초 × 24)

function checkOrderStatus() {
    if (checkCount >= maxChecks) {
        document.getElementById('reportStatus').innerHTML = '⚠️ 리포트 생성이 지연되고 있습니다.';
        document.getElementById('emailStatus').innerHTML = '📧 이메일로 완료 알림을 보내드립니다.';
        return;
    }
    
    fetch(`/order/status/{{ order_id }}`)
        .then(response => response.json())
        .then(data => {
            if (data.report_ready) {
                document.getElementById('reportStatus').innerHTML = '✅ 리포트 생성 완료';
                document.getElementById('emailStatus').innerHTML = '✅ 이메일 발송 완료';
                
                setTimeout(() => {
                    window.location.href = '/order/mypage';
                }, 2000);
            } else {
                checkCount++;
                setTimeout(checkOrderStatus, 5000);
            }
        })
        .catch(error => {
            console.error('상태 확인 오류:', error);
            setTimeout(checkOrderStatus, 5000);
        });
}

// 페이지 로드 후 5초 뒤부터 상태 체크 시작
setTimeout(checkOrderStatus, 5000);
</script>
{% endblock %}