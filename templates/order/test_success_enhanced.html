<!-- templates/order/test_success_enhanced.html -->
{% extends "base.html" %}

{% block title %}AI ì‚¬ì£¼ ë¶„ì„ ì™„ë£Œ - My Website{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ”® AI ì‚¬ì£¼ ë¶„ì„ ì™„ë£Œ</h1>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 inline-block">
            <p class="text-green-800">
                <strong>{{ user_name }}ë‹˜</strong>ì˜ ê°œì¸ ë§ì¶¤ ì‚¬ì£¼ ë¦¬í¬íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!
            </p>
            <p class="text-sm text-green-600 mt-1">
                ì£¼ë¬¸ë²ˆí˜¸: {{ order.id }} | {{ birthdate_str }} {{ gender_kr }}
            </p>
        </div>
    </div>

    <!-- ì‚¬ì£¼ ê¸°ë³¸ ì •ë³´ -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- ì‚¬ì£¼íŒ”ì -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                ğŸ“… ì‚¬ì£¼íŒ”ì
            </h2>
            <div class="grid grid-cols-4 gap-2 text-center">
                <div class="bg-red-50 p-3 rounded">
                    <div class="text-sm text-gray-600">å¹´æŸ±</div>
                    <div class="font-bold text-red-600">{{ pillars.year }}</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded">
                    <div class="text-sm text-gray-600">æœˆæŸ±</div>
                    <div class="font-bold text-yellow-600">{{ pillars.month }}</div>
                </div>
                <div class="bg-blue-50 p-3 rounded">
                    <div class="text-sm text-gray-600">æ—¥æŸ±</div>
                    <div class="font-bold text-blue-600">{{ pillars.day }}</div>
                </div>
                <div class="bg-green-50 p-3 rounded">
                    <div class="text-sm text-gray-600">æ™‚æŸ±</div>
                    <div class="font-bold text-green-600">{{ pillars.hour }}</div>
                </div>
            </div>
        </div>

        <!-- ì˜¤í–‰ ë¶„í¬ ì°¨íŠ¸ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                ğŸ“Š ì˜¤í–‰ ë°¸ëŸ°ìŠ¤
            </h2>
            {% if chart_base64 %}
            <div class="text-center">
                <img src="{{ chart_base64 }}" alt="ì˜¤í–‰ ì°¨íŠ¸" class="mx-auto max-w-full h-auto">
            </div>
            {% endif %}
            <div class="grid grid-cols-5 gap-2 mt-4 text-center text-sm">
                {% for element, count in elem_dict_kr.items() %}
                <div class="bg-gray-50 p-2 rounded">
                    <div class="font-semibold">{{ element }}</div>
                    <div class="text-blue-600">{{ count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- AI ë¶„ì„ ê²°ê³¼ -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                ğŸ¤– AI ì‹¬ì¸µ ë¶„ì„ ê²°ê³¼
            </h2>
            <button onclick="regenerateAI()" id="regenerateBtn" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                ğŸ”„ ì¬ìƒì„±
            </button>
        </div>
        
        <div id="aiAnalysisContent" class="prose max-w-none">
            {{ ai_analysis|safe }}
        </div>
        
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="aiLoadingState" class="hidden text-center py-8">
            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-blue-500 bg-blue-50">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                AIê°€ ìƒˆë¡œìš´ ë¶„ì„ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </div>
        </div>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
    <div class="bg-gray-50 rounded-lg p-6 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“¥ ë‹¤ìŒ ë‹¨ê³„</h3>
        <div class="grid md:grid-cols-3 gap-4">
            <button onclick="generatePDF()" id="pdfBtn"
                    class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
                ğŸ“„ PDF ë¦¬í¬íŠ¸ ìƒì„±
            </button>
            <a href="/order/mypage" 
               class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors text-center flex items-center justify-center">
                ğŸ“‹ êµ¬ë§¤ ë‚´ì—­ í™•ì¸
            </a>
            <a href="/saju/page1" 
               class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors text-center flex items-center justify-center">
                ğŸ”® ìƒˆ ì‚¬ì£¼ ë³´ê¸°
            </a>
        </div>
    </div>

    <!-- ì£¼ë¬¸ ì •ë³´ ìƒì„¸ -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ì£¼ë¬¸ ì •ë³´</h3>
        <div class="grid md:grid-cols-2 gap-4">
            <div class="space-y-2">
                <p><span class="font-semibold">ì£¼ë¬¸ ë²ˆí˜¸:</span> {{ order.id }}</p>
                <p><span class="font-semibold">ìƒí’ˆëª…:</span> AI ì‹¬ì¸µ ì‚¬ì£¼ ë¦¬í¬íŠ¸</p>
                <p><span class="font-semibold">ê¸ˆì•¡:</span> {{ order.amount }}ì›</p>
            </div>
            <div class="space-y-2">
                <p><span class="font-semibold">ì£¼ë¬¸ ì‹œê°„:</span> {{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                <p><span class="font-semibold">ìƒíƒœ:</span> 
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">{{ order.status }}</span>
                </p>
                <p><span class="font-semibold">ì‚¬ì£¼ í‚¤:</span> 
                    <code class="bg-gray-100 text-sm px-2 py-1 rounded">{{ order.saju_key }}</code>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
async function regenerateAI() {
    const btn = document.getElementById('regenerateBtn');
    const content = document.getElementById('aiAnalysisContent');
    const loading = document.getElementById('aiLoadingState');
    
    // UI ìƒíƒœ ë³€ê²½
    btn.disabled = true;
    btn.innerHTML = 'â³ ìƒì„± ì¤‘...';
    content.classList.add('hidden');
    loading.classList.remove('hidden');
    
    try {
        const response = await fetch(`/order/regenerate-ai/{{ order.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            content.innerHTML = result.analysis;
            showToast('AI ë¶„ì„ì´ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            showToast('AI ë¶„ì„ ì¬ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    } finally {
        // UI ìƒíƒœ ë³µì›
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ ì¬ìƒì„±';
        content.classList.remove('hidden');
        loading.classList.add('hidden');
    }
}

async function generatePDF() {
    const btn = document.getElementById('pdfBtn');
    btn.disabled = true;
    btn.innerHTML = 'â³ PDF ìƒì„± ì¤‘...';
    
    try {
        const response = await fetch(`/order/test-report/{{ order.id }}`);
        const result = await response.json();
        
        if (result.task_id) {
            showToast('PDF ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            // íƒœìŠ¤í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
            monitorTask(result.task_id);
        } else {
            showToast('PDF ìƒì„± ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“„ PDF ë¦¬í¬íŠ¸ ìƒì„±';
    }
}

async function monitorTask(taskId) {
    const checkInterval = setInterval(async () => {
        try {
            const response = await fetch(`/order/task-status/${taskId}`);
            const status = await response.json();
            
            if (status.state === 'success') {
                clearInterval(checkInterval);
                showToast('PDF ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else if (status.state === 'FAILURE') {
                clearInterval(checkInterval);
                showToast('PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + status.status, 'error');
            }
            // progress ìƒíƒœëŠ” ê³„ì† ì²´í¬
        } catch (error) {
            console.error('íƒœìŠ¤í¬ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
        }
    }, 2000); // 2ì´ˆë§ˆë‹¤ ì²´í¬
}

function showToast(message, type) {
    // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ì•Œë¦¼
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}