{% extends "base.html" %}
{% block title %}ì¥ë°”êµ¬ë‹ˆ{% endblock %}
{% block content %}
<div class="container mx-auto py-8">
  <h1 class="text-2xl font-bold mb-4">ì¥ë°”êµ¬ë‹ˆ</h1>
  
  {% if cart.items %}
    <div class="bg-white rounded shadow">
      <div class="p-4 border-b">
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold">ìƒí’ˆ ëª©ë¡ ({{ cart.total_items }}ê°œ)</span>
          <button onclick="clearCart()" class="text-red-500 hover:text-red-700">ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°</button>
        </div>
      </div>
      
      <div class="divide-y">
        {% for item in cart.items %}
        <div class="p-4 flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="w-16 h-16 bg-gray-200 rounded"></div>
            <div>
              <h3 class="font-semibold">{{ item.name }}</h3>
              <p class="text-gray-600">{{ item.price }}ì›</p>
              {% if item.fortune_cost %}
              <p class="text-blue-600">{{ item.fortune_cost }}P</p>
              {% endif %}
            </div>
          </div>
          
          <div class="flex items-center space-x-4">
            <div class="flex items-center border rounded">
              <button onclick="updateQuantity({{ item.id }}, {{ item.quantity - 1 }})" 
                      class="px-3 py-1 hover:bg-gray-100">-</button>
              <span class="px-3 py-1">{{ item.quantity }}</span>
              <button onclick="updateQuantity({{ item.id }}, {{ item.quantity + 1 }})" 
                      class="px-3 py-1 hover:bg-gray-100">+</button>
            </div>
            <button onclick="removeFromCart({{ item.id }})" 
                    class="text-red-500 hover:text-red-700">ì‚­ì œ</button>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <div class="p-4 border-t bg-gray-50">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-lg font-semibold">ì´ {{ cart.total_items }}ê°œ ìƒí’ˆ</p>
            <p class="text-gray-600">ì´ {{ cart.total_price }}ì›</p>
            {% if cart.total_fortune_cost %}
            <p class="text-blue-600">ì´ {{ cart.total_fortune_cost }}P</p>
            {% endif %}
          </div>
          <button onclick="checkout()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
            êµ¬ë§¤í•˜ê¸°
          </button>
        </div>
      </div>
    </div>
  {% else %}
    <div class="text-center py-12">
      <div class="text-gray-400 text-6xl mb-4">ğŸ›’</div>
      <h2 class="text-xl font-semibold mb-2">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</h2>
      <p class="text-gray-600 mb-6">ì›í•˜ëŠ” ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
      <a href="{{ url_for('shop_list') }}" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
        ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°
      </a>
    </div>
  {% endif %}
</div>

<script>
function updateQuantity(productId, quantity) {
  if (quantity <= 0) {
    removeFromCart(productId);
    return;
  }
  
  fetch('/cart/api/v1/update', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      product_id: productId,
      quantity: quantity,
      csrf_token: '{{ csrf_token }}',
      idempotency_key: Date.now().toString()
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ìˆ˜ëŸ‰ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
}

function removeFromCart(productId) {
  if (!confirm('ì´ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  fetch(`/cart/api/v1/remove/${productId}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('ì œê±° ì‹¤íŒ¨: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
}

function clearCart() {
  if (!confirm('ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  fetch('/cart/api/v1/clear', {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸° ì‹¤íŒ¨: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
}

function checkout() {
  // TODO: êµ¬ë§¤ í˜ì´ì§€ë¡œ ì´ë™
  alert('êµ¬ë§¤ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}
</script>
{% endblock %} 