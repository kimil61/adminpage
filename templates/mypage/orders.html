{% extends "base.html" %}

{% block title %}êµ¬ë§¤ ë‚´ì—­ - My Website{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">ğŸ“‹ êµ¬ë§¤ ë‚´ì—­</h1>
    
    {% if orders %}
        <div class="space-y-6">
            {% for order in orders %}
            <div class="bg-white rounded-xl shadow-md border p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">AI ì‹¬ì¸µ ì‚¬ì£¼ ë¦¬í¬íŠ¸</h3>
                        <p class="text-gray-600">ì£¼ë¬¸ë²ˆí˜¸: #{{ order.id }}</p>
                        <p class="text-sm text-gray-500">{{ order.created_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-purple-700">{{ "{:,}".format(order.amount) }}ì›</p>
                        {% if order.status == "paid" %}
                            <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">ê²°ì œì™„ë£Œ</span>
                        {% else %}
                            <span class="inline-block bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">{{ order.status }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- ğŸ¯ ë¦¬í¬íŠ¸ ìƒíƒœë³„ UI -->
                <div class="border-t pt-4">
                    {% if order.report_status == "pending" %}
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                            <span class="text-gray-600">â³ ë¦¬í¬íŠ¸ ìƒì„± ëŒ€ê¸° ì¤‘</span>
                        </div>
                    
                    {% elif order.report_status == "generating" %}
                        <div class="flex items-center space-x-3" id="generating-{{ order.id }}">
                            <div class="w-4 h-4 border-2 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                            <span class="text-purple-600">ğŸ”„ AI ë¶„ì„ ìƒì„± ì¤‘... (2-3ë¶„ ì†Œìš”)</span>
                        </div>
                        <div class="mt-2 bg-purple-50 rounded-lg p-3">
                            <div class="w-full bg-purple-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full progress-bar" style="width: 60%; animation: pulse 2s infinite;"></div>
                            </div>
                            <p class="text-xs text-purple-700 mt-1">ê³ í’ˆì§ˆ AI ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                    
                    {% elif order.report_status == "completed" %}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <span class="text-green-600">âœ… ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!</span>
                                {% if order.report_completed_at %}
                                <span class="text-xs text-gray-500">({{ order.report_completed_at.strftime('%m/%d %H:%M') }})</span>
                                {% endif %}
                            </div>
                            <div class="space-x-3">
                                <a href="/order/report/{{ order.id }}" 
                                   class="inline-block bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    ğŸ“„ ë¦¬í¬íŠ¸ í™•ì¸
                                </a>
                                <button onclick="shareReport({{ order.id }})" 
                                        class="inline-block bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                                    ğŸ“§ ì´ë©”ì¼ ë°œì†¡
                                </button>
                            </div>
                        </div>
                    
                    {% elif order.report_status == "failed" %}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                                <span class="text-red-600">âŒ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨</span>
                            </div>
                            <button onclick="retryReport({{ order.id }})" 
                                    class="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors">
                                ğŸ”„ ë‹¤ì‹œ ì‹œë„
                            </button>
                        </div>
                    {% endif %}
                </div>
                
                <!-- ì‚¬ì£¼ ì •ë³´ ë¯¸ë¦¬ë³´ê¸° -->
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">ì‚¬ì£¼ ì •ë³´:</span> {{ order.saju_key.replace('_', ' ') }}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ì„ ë•Œ -->
        <div class="text-center py-20">
            <div class="text-6xl mb-4">ğŸ“‹</div>
            <h2 class="text-2xl font-semibold text-gray-600 mb-4">ì•„ì§ êµ¬ë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h2>
            <p class="text-gray-500 mb-8">AI ì‹¬ì¸µ ì‚¬ì£¼ ë¦¬í¬íŠ¸ë¥¼ êµ¬ë§¤í•´ë³´ì„¸ìš”!</p>
            <a href="/saju/page1" class="inline-block bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                ì‚¬ì£¼ ë³´ëŸ¬ ê°€ê¸° â†’
            </a>
        </div>
    {% endif %}
</div>

<script>
// ğŸ¯ ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸
function checkGeneratingOrders() {
    const generatingElements = document.querySelectorAll('[id^="generating-"]');
    
    generatingElements.forEach(element => {
        const orderId = element.id.split('-')[1];
        
        fetch(`/order/status/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.report_ready) {
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•´ì„œ ìµœì‹  ìƒíƒœ ë°˜ì˜
                    window.location.reload();
                }
            })
            .catch(error => console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error));
    });
}

// 5ì´ˆë§ˆë‹¤ ìƒì„± ì¤‘ì¸ ì£¼ë¬¸ë“¤ ìƒíƒœ í™•ì¸
setInterval(checkGeneratingOrders, 5000);

// ì´ë©”ì¼ ë°œì†¡
function shareReport(orderId) {
    fetch(`/order/email/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                alert('ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:', error);
            alert('ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ë¦¬í¬íŠ¸ ì¬ìƒì„±
function retryReport(orderId) {
    if (confirm('ë¦¬í¬íŠ¸ë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // TODO: ì¬ìƒì„± API í˜¸ì¶œ
        alert('ë¦¬í¬íŠ¸ ì¬ìƒì„±ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.');
        window.location.reload();
    }
}
</script>

<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}