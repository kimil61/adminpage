{% extends "base.html" %}

{% block title %}포인트 충전 - 행운 포인트{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 페이지 헤더 -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-3">
                <i class="fas fa-plus-circle text-success"></i>
                포인트 충전
            </h1>
            <p class="text-muted">{{ user.username }}님의 포인트를 충전하세요</p>
        </div>
    </div>

    <!-- 현재 포인트 정보 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-coins me-2"></i>
                <div>
                    <strong>현재 보유 포인트:</strong> {{ "{:,}".format(fortune_info.points) }}P
                    <a href="{{ url_for('fortune_dashboard') }}" class="btn btn-sm btn-outline-primary ms-3">
                        대시보드로
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 충전 패키지 목록 -->
    <div class="row">
        {% if packages %}
            {% for package in packages %}
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 package-card {% if package.is_featured %}border-primary{% endif %}">
                    {% if package.is_featured %}
                    <div class="card-header bg-primary text-white text-center">
                        <i class="fas fa-star"></i> 추천 패키지
                    </div>
                    {% endif %}
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-center">{{ package.name }}</h5>
                        <p class="card-text text-muted text-center">{{ package.description }}</p>
                        
                        <!-- 포인트 정보 -->
                        <div class="text-center mb-3">
                            <div class="display-6 fw-bold text-success mb-1">
                                {{ "{:,}".format(package.fortune_points + package.bonus_points) }}P
                            </div>
                            <div class="text-muted">
                                기본 {{ "{:,}".format(package.fortune_points) }}P
                                {% if package.bonus_points > 0 %}
                                <span class="text-success">+ 보너스 {{ "{:,}".format(package.bonus_points) }}P</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 가격 정보 -->
                        <div class="text-center mb-3">
                            <div class="h4 fw-bold text-primary mb-1">
                                {{ "{:,}".format(package.price) }}원
                            </div>
                            {% if package.discount_rate > 0 %}
                            <div class="text-success">
                                <i class="fas fa-percentage"></i> {{ package.discount_rate }}% 할인
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- 추가 정보 -->
                        <ul class="list-unstyled mb-3">
                            <li><i class="fas fa-calendar-alt text-muted me-2"></i> 유효기간: {{ package.expires_days }}일</li>
                            {% if package.max_purchase_per_user %}
                            <li><i class="fas fa-limit text-muted me-2"></i> 최대 구매: {{ package.max_purchase_per_user }}개</li>
                            {% endif %}
                        </ul>
                        
                        <!-- 충전 버튼 -->
                        <div class="mt-auto">
                            <button class="btn btn-success w-100 charge-btn" 
                                    data-package-id="{{ package.id }}"
                                    data-package-name="{{ package.name }}"
                                    data-package-price="{{ package.price }}">
                                <i class="fas fa-plus"></i> 충전하기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h4>충전 패키지가 없습니다</h4>
                    <p class="text-muted">관리자에게 문의해주세요.</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- 충전 안내 -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-info"></i>
                        충전 안내
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-check text-success"></i> 충전 즉시 사용 가능</h6>
                            <p class="text-muted small">충전 완료 후 즉시 포인트를 사용할 수 있습니다.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-clock text-warning"></i> 유효기간 확인</h6>
                            <p class="text-muted small">포인트는 충전일로부터 설정된 기간 동안 유효합니다.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-shield-alt text-primary"></i> 안전한 결제</h6>
                            <p class="text-muted small">카카오페이를 통한 안전한 결제를 제공합니다.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-undo text-info"></i> 환불 정책</h6>
                            <p class="text-muted small">사용하지 않은 포인트는 환불이 가능합니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 충전 모달 -->
<div class="modal fade" id="chargeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">포인트 충전 확인</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>다음 패키지를 충전하시겠습니까?</p>
                <div class="alert alert-info">
                    <strong id="modalPackageName"></strong><br>
                    <span id="modalPackagePrice"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-success" id="confirmCharge">
                    <i class="fas fa-credit-card"></i> 결제 진행
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.package-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: 2px solid transparent;
}

.package-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.package-card.border-primary {
    border-color: #0d6efd;
}

.charge-btn {
    transition: all 0.2s;
}

.charge-btn:hover {
    transform: scale(1.05);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 충전 버튼 클릭 이벤트
    const chargeButtons = document.querySelectorAll('.charge-btn');
    const modal = new bootstrap.Modal(document.getElementById('chargeModal'));
    
    chargeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const packageId = this.dataset.packageId;
            const packageName = this.dataset.packageName;
            const packagePrice = this.dataset.packagePrice;
            
            // 모달 내용 설정
            document.getElementById('modalPackageName').textContent = packageName;
            document.getElementById('modalPackagePrice').textContent = packagePrice + '원';
            
            // 모달 표시
            modal.show();
            
            // 확인 버튼 이벤트
            document.getElementById('confirmCharge').onclick = function() {
                // CSRF 토큰 가져오기
                const csrfToken = '{{ csrf_token }}';
                
                // 충전 API 호출
                fetch('/fortune/api/v1/charge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        package_id: parseInt(packageId),
                        csrf_token: csrfToken,
                        idempotency_key: Date.now().toString()
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.data.redirect_url) {
                            window.location.href = data.data.redirect_url;
                        } else {
                            alert('충전이 완료되었습니다!');
                            window.location.reload();
                        }
                    } else {
                        alert('충전 실패: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('충전 중 오류가 발생했습니다.');
                });
                
                modal.hide();
            };
        });
    });
});
</script>
{% endblock %} 