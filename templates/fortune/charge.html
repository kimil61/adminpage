{% extends "base.html" %}

{% block title %}ν¬μΈνΈ μ¶©μ „ - ν–‰μ΄ ν¬μΈνΈ{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- ν—¤λ” -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">ν¬μΈνΈ μ¶©μ „</h1>
        <p class="text-gray-600">μ›ν•λ” ν¨ν‚¤μ§€λ¥Ό μ„ νƒν•μ—¬ ν¬μΈνΈλ¥Ό μ¶©μ „ν•μ„Έμ”</p>
    </div>

    <!-- ν„μ¬ ν¬μΈνΈ ν‘μ‹ -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <span class="text-sm text-blue-600">ν„μ¬ ν¬μΈνΈ</span>
                <span class="ml-2 text-lg font-bold text-blue-800">{{ "{:,}".format(fortune_points or 0) }}P</span>
            </div>
            <a href="/fortune" class="text-blue-600 hover:text-blue-800 text-sm">
                λ€μ‹λ³΄λ“λ΅ β†’
            </a>
        </div>
    </div>

    <!-- ν¨ν‚¤μ§€ λ©λ΅ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for package in packages %}
        <div class="bg-white rounded-lg shadow-sm border hover:shadow-md transition-shadow {% if package.is_featured %}ring-2 ring-purple-500{% endif %}">
            <!-- μ¶”μ² λ°°μ§€ -->
            {% if package.is_featured %}
            <div class="bg-purple-500 text-white text-center py-2 rounded-t-lg">
                <span class="text-sm font-semibold">μ¶”μ²</span>
            </div>
            {% endif %}
            
            <!-- ν¨ν‚¤μ§€ μ •λ³΄ -->
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-2">{{ package.name }}</h3>
                <p class="text-gray-600 text-sm mb-4">{{ package.description }}</p>
                
                <!-- ν¬μΈνΈ μ •λ³΄ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600 mb-1">
                            {{ "{:,}".format(package.total_points) }}P
                        </div>
                        <div class="text-sm text-gray-600">
                            κΈ°λ³Έ {{ "{:,}".format(package.fortune_points) }}P
                            {% if package.bonus_points > 0 %}
                            + λ³΄λ„μ¤ {{ "{:,}".format(package.bonus_points) }}P
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- κ°€κ²© μ •λ³΄ -->
                <div class="text-center mb-4">
                    {% if package.discount_rate > 0 %}
                    <div class="text-lg text-gray-500 line-through mb-1">
                        {{ "{:,}".format(package.original_price) }}μ›
                    </div>
                    <div class="text-2xl font-bold text-blue-600 mb-1">
                        {{ "{:,}".format(package.discounted_price) }}μ›
                    </div>
                    <div class="text-sm text-red-600 mb-2">
                        {{ package.discount_rate }}% ν• μΈ
                    </div>
                    <div class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full inline-block">
                        {{ "{:,}".format(package.savings) }}μ› μ μ•½
                    </div>
                    {% else %}
                    <div class="text-2xl font-bold text-blue-600 mb-1">
                        {{ "{:,}".format(package.price) }}μ›
                    </div>
                    {% endif %}
                </div>
                
                <!-- μ¶”κ°€ μ •λ³΄ -->
                <div class="space-y-2 mb-6 text-sm text-gray-600">
                    {% if package.expires_days > 0 %}
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        {{ package.expires_days }}μΌ ν›„ λ§λ£
                    </div>
                    {% endif %}
                    
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        μ¦‰μ‹ μ λ¦½
                    </div>
                </div>
                
                <!-- μ¶©μ „ λ²„νΌ -->
                <button onclick="chargePoints({{ package.id }})" 
                        class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                    μ¶©μ „ν•κΈ°
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ν¨ν‚¤μ§€κ°€ μ—†μ„ λ• -->
    {% if not packages %}
    <div class="text-center py-12">
        <div class="text-gray-400 text-6xl mb-4">π“¦</div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">μ¶©μ „ ν¨ν‚¤μ§€κ°€ μ—†μµλ‹λ‹¤</h3>
        <p class="text-gray-600">μ μ‹ ν›„ λ‹¤μ‹ μ‹λ„ν•΄μ£Όμ„Έμ”.</p>
    </div>
    {% endif %}

    <!-- μ•λ‚΄ μ‚¬ν•­ -->
    <div class="mt-12 bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">μ¶©μ „ μ•λ‚΄</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-600">
            <div>
                <h4 class="font-medium text-gray-900 mb-2">κ²°μ  λ°©λ²•</h4>
                <ul class="space-y-1">
                    <li>β€Ά μΉ΄μΉ΄μ¤νμ΄ κ²°μ </li>
                    <li>β€Ά μ‹ μ©μΉ΄λ“, μ²΄ν¬μΉ΄λ“</li>
                    <li>β€Ά κ³„μΆμ΄μ²΄</li>
                </ul>
            </div>
            <div>
                <h4 class="font-medium text-gray-900 mb-2">μ£Όμμ‚¬ν•­</h4>
                <ul class="space-y-1">
                    <li>β€Ά ν¬μΈνΈλ” κµ¬λ§¤ ν›„ μ¦‰μ‹ μ λ¦½λ©λ‹λ‹¤</li>
                    <li>β€Ά μΌλ¶€ ν¬μΈνΈλ” λ§λ£μΌμ΄ μμµλ‹λ‹¤</li>
                    <li>β€Ά ν™λ¶μ€ κµ¬λ§¤ ν›„ 7μΌ μ΄λ‚΄μ—λ§ κ°€λ¥ν•©λ‹λ‹¤</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- μ¶©μ „ ν™•μΈ λ¨λ‹¬ -->
<div id="chargeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">ν¬μΈνΈ μ¶©μ „ ν™•μΈ</h3>
            <div id="modalContent" class="mb-6">
                <!-- λ¨λ‹¬ λ‚΄μ©μ΄ μ—¬κΈ°μ— λ™μ μΌλ΅ μ‚½μ…λ©λ‹λ‹¤ -->
            </div>
            
            <div class="flex space-x-3">
                <button onclick="confirmCharge()" 
                        class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700">
                    μ¶©μ „ν•κΈ°
                </button>
                <button onclick="closeChargeModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">
                    μ·¨μ†
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const packages = {{ packages|tojson }};
let selectedPackage = null;

function chargePoints(packageId) {
    // μ„ νƒλ ν¨ν‚¤μ§€ μ •λ³΄ μ°ΎκΈ°
    selectedPackage = packages.find(p => p.id === packageId);
    
    if (!selectedPackage) {
        alert('ν¨ν‚¤μ§€ μ •λ³΄λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤.');
        return;
    }
    
    // λ¨λ‹¬ λ‚΄μ© μƒμ„±
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <div class="space-y-4">
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-2">${selectedPackage.name}</h4>
                <p class="text-sm text-gray-600 mb-2">${selectedPackage.description}</p>
                <div class="text-center">
                    <div class="text-xl font-bold text-purple-600 mb-1">
                        ${selectedPackage.total_points.toLocaleString()}P
                    </div>
                    <div class="text-sm text-gray-600">
                        κΈ°λ³Έ ${selectedPackage.fortune_points.toLocaleString()}P
                        ${selectedPackage.bonus_points > 0 ? `+ λ³΄λ„μ¤ ${selectedPackage.bonus_points.toLocaleString()}P` : ''}
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <div class="text-lg font-bold text-blue-600">
                    ${selectedPackage.discounted_price ? selectedPackage.discounted_price.toLocaleString() : selectedPackage.price.toLocaleString()}μ›
                </div>
                ${selectedPackage.discount_rate > 0 ? `
                <div class="text-sm text-red-600">
                    ${selectedPackage.discount_rate}% ν• μΈ
                </div>
                ` : ''}
            </div>
            
            <p class="text-sm text-gray-600 text-center">
                μΉ΄μΉ΄μ¤νμ΄λ΅ κ²°μ ν•μ‹κ² μµλ‹κΉ?
            </p>
        </div>
    `;
    
    showChargeModal();
}

function showChargeModal() {
    document.getElementById('chargeModal').classList.remove('hidden');
}

function closeChargeModal() {
    document.getElementById('chargeModal').classList.add('hidden');
    selectedPackage = null;
}

function confirmCharge() {
    if (!selectedPackage) {
        alert('ν¨ν‚¤μ§€ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤.');
        return;
    }
    
    const formData = new FormData();
    formData.append('package_id', selectedPackage.id);
    formData.append('csrf_token', '{{ csrf_token }}');
    
    fetch('/fortune/api/v1/charge', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // μΉ΄μΉ΄μ¤νμ΄ κ²°μ  νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
            window.location.href = data.data.redirect_url;
        } else {
            alert('μ¶©μ „ μ¤€λΉ„ μ‹¤ν¨: ' + data.detail);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('μ¶©μ „ μ¤€λΉ„ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
    })
    .finally(() => {
        closeChargeModal();
    });
}

// λ¨λ‹¬ μ™Έλ¶€ ν΄λ¦­ μ‹ λ‹«κΈ°
document.getElementById('chargeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeChargeModal();
    }
});
</script>
{% endblock %} 