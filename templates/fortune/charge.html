{% extends "base.html" %}

{% block title %}포인트 충전 - 행운 포인트{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- 헤더 -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">포인트 충전</h1>
        <p class="text-gray-600">원하는 패키지를 선택하여 포인트를 충전하세요</p>
    </div>

    <!-- 현재 포인트 표시 -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <span class="text-sm text-blue-600">현재 포인트</span>
                <span class="ml-2 text-lg font-bold text-blue-800">{{ "{:,}".format(fortune_points or 0) }}P</span>
            </div>
            <a href="/fortune" class="text-blue-600 hover:text-blue-800 text-sm">
                대시보드로 →
            </a>
        </div>
    </div>

    <!-- 패키지 목록 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for package in packages %}
        <div class="bg-white rounded-lg shadow-sm border hover:shadow-md transition-shadow {% if package.is_featured %}ring-2 ring-purple-500{% endif %}">
            <!-- 추천 배지 -->
            {% if package.is_featured %}
            <div class="bg-purple-500 text-white text-center py-2 rounded-t-lg">
                <span class="text-sm font-semibold">추천</span>
            </div>
            {% endif %}
            
            <!-- 패키지 정보 -->
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-2">{{ package.name }}</h3>
                <p class="text-gray-600 text-sm mb-4">{{ package.description }}</p>
                
                <!-- 포인트 정보 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600 mb-1">
                            {{ "{:,}".format(package.total_points) }}P
                        </div>
                        <div class="text-sm text-gray-600">
                            기본 {{ "{:,}".format(package.fortune_points) }}P
                            {% if package.bonus_points > 0 %}
                            + 보너스 {{ "{:,}".format(package.bonus_points) }}P
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- 가격 정보 -->
                <div class="text-center mb-4">
                    {% if package.discount_rate > 0 %}
                    <div class="text-lg text-gray-500 line-through mb-1">
                        {{ "{:,}".format(package.original_price) }}원
                    </div>
                    <div class="text-2xl font-bold text-blue-600 mb-1">
                        {{ "{:,}".format(package.discounted_price) }}원
                    </div>
                    <div class="text-sm text-red-600 mb-2">
                        {{ package.discount_rate }}% 할인
                    </div>
                    <div class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full inline-block">
                        {{ "{:,}".format(package.savings) }}원 절약
                    </div>
                    {% else %}
                    <div class="text-2xl font-bold text-blue-600 mb-1">
                        {{ "{:,}".format(package.price) }}원
                    </div>
                    {% endif %}
                </div>
                
                <!-- 추가 정보 -->
                <div class="space-y-2 mb-6 text-sm text-gray-600">
                    {% if package.expires_days > 0 %}
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        {{ package.expires_days }}일 후 만료
                    </div>
                    {% endif %}
                    
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        즉시 적립
                    </div>
                </div>
                
                <!-- 충전 버튼 -->
                <button onclick="chargePoints({{ package.id }})" 
                        class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                    충전하기
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 패키지가 없을 때 -->
    {% if not packages %}
    <div class="text-center py-12">
        <div class="text-gray-400 text-6xl mb-4">📦</div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">충전 패키지가 없습니다</h3>
        <p class="text-gray-600">잠시 후 다시 시도해주세요.</p>
    </div>
    {% endif %}

    <!-- 안내 사항 -->
    <div class="mt-12 bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">충전 안내</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-600">
            <div>
                <h4 class="font-medium text-gray-900 mb-2">결제 방법</h4>
                <ul class="space-y-1">
                    <li>• 카카오페이 결제</li>
                    <li>• 신용카드, 체크카드</li>
                    <li>• 계좌이체</li>
                </ul>
            </div>
            <div>
                <h4 class="font-medium text-gray-900 mb-2">주의사항</h4>
                <ul class="space-y-1">
                    <li>• 포인트는 구매 후 즉시 적립됩니다</li>
                    <li>• 일부 포인트는 만료일이 있습니다</li>
                    <li>• 환불은 구매 후 7일 이내에만 가능합니다</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 충전 확인 모달 -->
<div id="chargeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">포인트 충전 확인</h3>
            <div id="modalContent" class="mb-6">
                <!-- 모달 내용이 여기에 동적으로 삽입됩니다 -->
            </div>
            
            <div class="flex space-x-3">
                <button onclick="confirmCharge()" 
                        class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700">
                    충전하기
                </button>
                <button onclick="closeChargeModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">
                    취소
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const packages = {{ packages|tojson }};
let selectedPackage = null;

function chargePoints(packageId) {
    // 선택된 패키지 정보 찾기
    selectedPackage = packages.find(p => p.id === packageId);
    
    if (!selectedPackage) {
        alert('패키지 정보를 찾을 수 없습니다.');
        return;
    }
    
    // 모달 내용 생성
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <div class="space-y-4">
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-2">${selectedPackage.name}</h4>
                <p class="text-sm text-gray-600 mb-2">${selectedPackage.description}</p>
                <div class="text-center">
                    <div class="text-xl font-bold text-purple-600 mb-1">
                        ${selectedPackage.total_points.toLocaleString()}P
                    </div>
                    <div class="text-sm text-gray-600">
                        기본 ${selectedPackage.fortune_points.toLocaleString()}P
                        ${selectedPackage.bonus_points > 0 ? `+ 보너스 ${selectedPackage.bonus_points.toLocaleString()}P` : ''}
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <div class="text-lg font-bold text-blue-600">
                    ${selectedPackage.discounted_price ? selectedPackage.discounted_price.toLocaleString() : selectedPackage.price.toLocaleString()}원
                </div>
                ${selectedPackage.discount_rate > 0 ? `
                <div class="text-sm text-red-600">
                    ${selectedPackage.discount_rate}% 할인
                </div>
                ` : ''}
            </div>
            
            <p class="text-sm text-gray-600 text-center">
                카카오페이로 결제하시겠습니까?
            </p>
        </div>
    `;
    
    showChargeModal();
}

function showChargeModal() {
    document.getElementById('chargeModal').classList.remove('hidden');
}

function closeChargeModal() {
    document.getElementById('chargeModal').classList.add('hidden');
    selectedPackage = null;
}

function confirmCharge() {
    if (!selectedPackage) {
        alert('패키지 정보가 없습니다.');
        return;
    }
    
    const formData = new FormData();
    formData.append('package_id', selectedPackage.id);
    formData.append('csrf_token', '{{ csrf_token }}');
    
    fetch('/fortune/api/v1/charge', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 카카오페이 결제 페이지로 리다이렉트
            window.location.href = data.data.redirect_url;
        } else {
            alert('충전 준비 실패: ' + data.detail);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('충전 준비 중 오류가 발생했습니다.');
    })
    .finally(() => {
        closeChargeModal();
    });
}

// 모달 외부 클릭 시 닫기
document.getElementById('chargeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeChargeModal();
    }
});
</script>
{% endblock %} 