import os
import logging
from datetime import datetime, timedelta
from celery import current_task
from app.celery_app import celery_app
from sqlalchemy.orm import Session
from app.database import SessionLocal
from app.models import Order, SajuAnalysisCache, SajuUser
from app.routers.saju import (
    load_prompt,
    test_ollama_connection,
    calculate_four_pillars,
    analyze_four_pillars_to_string,
    ai_sajupalja_with_ollama,
)
from markdown import markdown
import pdfkit
from fpdf import FPDF
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication
from jinja2 import Environment, FileSystemLoader, select_autoescape
from app.report_utils import radar_chart_base64, month_heat_table, keyword_card

# Î°úÍ±∞ ÏÑ§Ï†ï
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def html_to_pdf_improved(html: str, output_path: str) -> bool:
    """HTMLÏùÑ PDFÎ°ú Î≥ÄÌôò (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)"""
    try:
        # wkhtmltopdf ÏòµÏÖò ÏÑ§Ï†ï (Í∞úÏÑ†Îê®)
        options = {
            'page-size': 'A4',
            'margin-top': '20mm',
            'margin-right': '20mm', 
            'margin-bottom': '20mm',
            'margin-left': '20mm',
            'encoding': "UTF-8",
            'no-outline': None,
            'enable-local-file-access': None,
            'print-media-type': None,  # CSS @media print Ï†ÅÏö©
            'disable-smart-shrinking': None,  # ÏûêÎèô Ï∂ïÏÜå ÎπÑÌôúÏÑ±Ìôî
            'zoom': 1.0,
            'dpi': 300,  # Í≥†Ìï¥ÏÉÅÎèÑ
            'image-quality': 100,
            'javascript-delay': 1000,  # JS Ïã§Ìñâ ÎåÄÍ∏∞
        }
        
        # HTMLÏóê Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
        styled_html = f"""
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
                
                body {{ 
                    font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; 
                    line-height: 1.6; 
                    margin: 40px;
                    color: #333;
                    background: white;
                }}
                
                h1 {{ 
                    color: #8B5CF6; 
                    text-align: center; 
                    font-size: 28px;
                    margin-bottom: 30px;
                    border-bottom: 3px solid #8B5CF6;
                    padding-bottom: 15px;
                }}
                
                h2 {{ 
                    color: #7C3AED; 
                    margin-top: 32px; 
                    margin-bottom: 16px;
                    font-size: 20px;
                    border-left: 4px solid #7C3AED;
                    padding-left: 12px;
                }}
                
                .mini-cal {{ 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 20px 0;
                }}
                
                .mini-cal td, .mini-cal th {{ 
                    padding: 8px 12px; 
                    text-align: center; 
                    font-size: 12px; 
                    border: 1px solid #ddd;
                }}
                
                .mini-cal th {{
                    background-color: #f8f9fa;
                    font-weight: bold;
                }}
                
                .card {{ 
                    background: #FFF7ED; 
                    border-radius: 8px; 
                    padding: 20px; 
                    margin: 15px 0;
                    border: 1px solid #F3E8FF;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }}
                
                .card h3 {{
                    color: #7C3AED;
                    margin-top: 0;
                    margin-bottom: 15px;
                }}
                
                .card ul {{
                    list-style: none;
                    padding: 0;
                    margin: 0;
                }}
                
                .card li {{
                    padding: 5px 0;
                    border-bottom: 1px solid #E5E7EB;
                }}
                
                .card li:last-child {{
                    border-bottom: none;
                }}
                
                .checklist {{ 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 20px 0;
                }}
                
                .checklist td, .checklist th {{ 
                    padding: 10px 12px; 
                    font-size: 13px; 
                    border: 1px solid #ddd;
                    text-align: left;
                }}
                
                .checklist th {{
                    background-color: #7C3AED;
                    color: white;
                    font-weight: bold;
                }}
                
                .checklist tr:nth-child(even) {{
                    background-color: #f8f9fa;
                }}
                
                .ai-analysis {{
                    background: #F8FAFC;
                    border-left: 4px solid #3B82F6;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 0 8px 8px 0;
                }}
                
                .ai-analysis p {{
                    margin-bottom: 15px;
                    line-height: 1.7;
                }}
                
                .footer-note {{
                    margin-top: 40px; 
                    text-align: center; 
                    color: #6B7280; 
                    font-size: 11px;
                    border-top: 1px solid #E5E7EB;
                    padding-top: 20px;
                }}
                
                /* Ïù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôî */
                img {{
                    max-width: 100%;
                    height: auto;
                    display: block;
                    margin: 20px auto;
                }}
                
                /* ÌîÑÎ¶∞Ìä∏Ïö© ÏµúÏ†ÅÌôî */
                @media print {{
                    body {{ margin: 15mm; }}
                    h1 {{ page-break-after: avoid; }}
                    .card {{ page-break-inside: avoid; }}
                    .checklist {{ page-break-inside: avoid; }}
                }}
            </style>
        </head>
        <body>
            {html}
        </body>
        </html>
        """
        
        pdfkit.from_string(styled_html, output_path, options=options)
        logger.info(f"‚úÖ PDF ÏÉùÏÑ± ÏÑ±Í≥µ: {output_path}")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå wkhtmltopdf Ïã§Ìå®: {e}")
        logger.info("üîÑ FPDFÎ°ú ÎåÄÏ≤¥ ÏãúÎèÑ Ï§ë...")
        
        try:
            # FPDF ÎåÄÏ≤¥ Î∞©Î≤ï (Í∞úÏÑ†Îê®)
            class UTF8PDF(FPDF):
                def __init__(self):
                    super().__init__()
                    self.add_font('malgun', '', 'malgun.ttf', uni=True)  # ÌïúÍ∏Ä Ìè∞Ìä∏ Ï∂îÍ∞Ä ÏãúÎèÑ
                
                def header(self):
                    if hasattr(self, 'title_text'):
                        self.set_font('Arial', 'B', 15)
                        self.cell(0, 10, self.title_text.encode('latin-1', 'ignore').decode('latin-1'), 0, 1, 'C')
                        self.ln(10)
                
                def add_text(self, text):
                    try:
                        self.set_font('malgun', size=12)
                    except:
                        self.set_font('Arial', size=12)
                    
                    # HTML ÌÉúÍ∑∏ Ï†úÍ±∞
                    import re
                    clean_text = re.sub('<[^<]+?>', '', text)
                    clean_text = clean_text.replace('&nbsp;', ' ').replace('&lt;', '<').replace('&gt;', '>')
                    
                    # ÌÖçÏä§Ìä∏Î•º Ï§Ñ Îã®ÏúÑÎ°ú Ï≤òÎ¶¨
                    for line in clean_text.split('\n'):
                        if line.strip():
                            try:
                                self.multi_cell(0, 8, txt=line.strip(), align='L')
                                self.ln(2)
                            except UnicodeEncodeError:
                                # ÌïúÍ∏Ä Ï≤òÎ¶¨ Ïã§Ìå® Ïãú ASCIIÎßå Ï∂îÏ∂ú
                                ascii_line = ''.join(char for char in line if ord(char) < 128)
                                if ascii_line.strip():
                                    self.multi_cell(0, 8, txt=ascii_line.strip(), align='L')
                                    self.ln(2)
            
            pdf = UTF8PDF()
            pdf.title_text = "ÏÇ¨Ï£ºÌåîÏûê Î¶¨Ìè¨Ìä∏"
            pdf.add_page()
            pdf.add_text(html)
            pdf.output(output_path)
            
            logger.info(f"‚úÖ FPDFÎ°ú PDF ÏÉùÏÑ± ÏôÑÎ£å: {output_path}")
            return True
            
        except Exception as e2:
            logger.error(f"‚ùå PDF ÏÉùÏÑ± ÏôÑÏ†Ñ Ïã§Ìå®: {e2}")
            return False

def generate_enhanced_report_html(user_name, pillars, analysis_result, elem_dict_kr):
    """Ìñ•ÏÉÅÎêú HTML Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±"""
    try:
        # Î†àÏù¥Îçî Ï∞®Ìä∏ ÏÉùÏÑ±
        radar_base64 = radar_chart_base64({
            'Wood': elem_dict_kr.get('Î™©', 0),
            'Fire': elem_dict_kr.get('Ìôî', 0), 
            'Earth': elem_dict_kr.get('ÌÜ†', 0),
            'Metal': elem_dict_kr.get('Í∏à', 0),
            'Water': elem_dict_kr.get('Ïàò', 0),
        })
        
        # ÏõîÎ≥Ñ Ïö¥ÏÑ∏ Îç∞Î™® Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†úÎ°úÎäî AI Î∂ÑÏÑù Í≤∞Í≥ºÎ°ú ÍµêÏ≤¥)
        status_demo = {
            'Love': ['G', 'R', '-', 'G', 'Y', '-', 'G', 'Y', '-', 'G', 'R', '-'],
            'Money': ['-', 'G', 'R', 'Y', '-', 'G', '-', 'G', 'Y', '-', 'G', 'R'],
            'Career': ['Y', '-', 'G', 'G', 'R', '-', 'Y', '-', 'G', 'Y', '-', 'G'],
        }
        calendar_html = month_heat_table(status_demo)
        keyword_html = keyword_card('ÏûêÏ£ºÏÉâ', [3, 7, 9], 'ÏûêÏàòÏ†ï')
        
        checklist = [
            {'cat': 'ÏäµÍ¥Ä Í∞úÏÑ†', 'action': 'Îß§Ïùº ÏïÑÏπ® 10Î∂Ñ Î™ÖÏÉÅÌïòÍ∏∞'},
            {'cat': 'Ïû¨Î¨º Í¥ÄÎ¶¨', 'action': 'Ïõî ÏÜåÎπÑ ÏòàÏÇ∞ 5% Ï§ÑÏù¥Í∏∞'},
            {'cat': 'Ïù∏Í∞ÑÍ¥ÄÍ≥Ñ', 'action': 'Îß§Ï£º Í∞ÄÏ°±/ÏπúÍµ¨ÏóêÍ≤å ÏïàÎ∂Ä Î¨ªÍ∏∞'},
            {'cat': 'Í±¥Í∞ï Í¥ÄÎ¶¨', 'action': 'Ï£º 3Ìöå Ïù¥ÏÉÅ Ïö¥ÎèôÌïòÍ∏∞'},
            {'cat': 'ÏûêÍ∏∞Í≥ÑÎ∞ú', 'action': 'Ìïú Îã¨Ïóê Ï±Ö 1Í∂å ÏùΩÍ∏∞'},
        ]
        
        # Jinja2 ÌôòÍ≤Ω ÏÑ§Ï†ï
        env = Environment(
            loader=FileSystemLoader('templates'),
            autoescape=select_autoescape(['html'])
        )
        
        # ÌÖúÌîåÎ¶ø Î†åÎçîÎßÅ
        template = env.get_template('report_base.html')
        html_content = template.render(
            user_name=user_name,
            pillars=pillars,
            radar_base64=radar_base64,
            calendar_html=calendar_html, 
            keyword_html=keyword_html,
            checklist=checklist,
            analysis_result=analysis_result,
            elem_dict_kr=elem_dict_kr
        )
        
        return html_content
        
    except Exception as e:
        logger.error(f"HTML Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: {e}")
        # Ìè¥Î∞± HTML
        return f"""
        <h1>üîÆ {user_name}ÎãòÏùò ÏÇ¨Ï£ºÌåîÏûê Î¶¨Ìè¨Ìä∏</h1>
        <h2>AI Ïã¨Ï∏µ Î∂ÑÏÑù</h2>
        <div class="ai-analysis">
            {markdown(analysis_result.replace('\\n', '\\n\\n'))}
        </div>
        <div class="footer-note">
            Î≥∏ Î¶¨Ìè¨Ìä∏Îäî AI Î∂ÑÏÑù Í≤∞Í≥ºÏù¥Î©∞ Ï∞∏Í≥†Ïö©ÏûÖÎãàÎã§.
        </div>
        """

@celery_app.task(bind=True, name='app.tasks.generate_full_report')
def generate_full_report(self, order_id: int, saju_key: str):
    """ÏôÑÏ†ÑÌïú AI Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± ÌÉúÏä§ÌÅ¨ (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)"""
    db: Session = SessionLocal()
    
    try:
        # ÏßÑÌñâ ÏÉÅÌô© ÏóÖÎç∞Ïù¥Ìä∏
        self.update_state(state='progress', meta={'current': 1, 'total': 6, 'status': 'Ï£ºÎ¨∏ Ï†ïÎ≥¥ ÌôïÏù∏ Ï§ë...'})
        
        order = db.query(Order).filter(Order.id == order_id).first()
        if not order:
            raise Exception(f'Order {order_id} not found')

        # ÌîÑÎ°¨ÌîÑÌä∏ Î°úÎìú
        self.update_state(state='progress', meta={'current': 2, 'total': 6, 'status': 'AI Î™®Îç∏ Ï§ÄÎπÑ Ï§ë...'})
        
        prompt = load_prompt()
        if not prompt:
            raise Exception('Prompt file missing')
        
        if not test_ollama_connection():
            raise Exception('Ollama connection failed')

        # ÏÇ¨Ï£º Í≥ÑÏÇ∞
        self.update_state(state='progress', meta={'current': 3, 'total': 6, 'status': 'ÏÇ¨Ï£º Î∂ÑÏÑù Ï§ë...'})
        
        birthdate_str, birth_hour, gender = saju_key.split('_')
        birth_year, birth_month, birth_day = map(int, birthdate_str.split('-'))
        birth_hour = int(birth_hour)
        
        pillars = calculate_four_pillars(datetime(birth_year, birth_month, birth_day, birth_hour))
        elem_dict_kr, result_text = analyze_four_pillars_to_string(
            pillars['year'][0], pillars['year'][1],
            pillars['month'][0], pillars['month'][1], 
            pillars['day'][0], pillars['day'][1],
            pillars['hour'][0], pillars['hour'][1],
        )

        # AI Î∂ÑÏÑù Ïã§Ìñâ
        self.update_state(state='progress', meta={'current': 4, 'total': 6, 'status': 'AI Ïã¨Ï∏µ Î∂ÑÏÑù Ï§ë...'})
        
        combined_text = "\n".join([
            "Ïò§Ìñâ Î∂ÑÌè¨:",
            ", ".join([f"{k}:{v}" for k, v in elem_dict_kr.items()]),
            "",
            result_text,
        ])
        
        analysis_result = ai_sajupalja_with_ollama(prompt=prompt, content=combined_text)
        if not analysis_result:
            raise Exception('Failed to generate AI analysis')

        # Ï∫êÏãúÏóê Ï†ÄÏû•
        cache = db.query(SajuAnalysisCache).filter_by(saju_key=saju_key).first()
        if cache:
            cache.analysis_full = analysis_result
        else:
            cache = SajuAnalysisCache(saju_key=saju_key, analysis_full=analysis_result)
            db.add(cache)
        db.commit()
        order.analysis_cache_id = cache.id

        # ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ ÌôïÏù∏
        saju_user = db.query(SajuUser).filter_by(saju_key=order.saju_key).first()
        user_name = saju_user.name if saju_user and getattr(saju_user, "name", None) else "Í≥†Í∞ù"

        # HTML & PDF ÏÉùÏÑ±
        self.update_state(state='progress', meta={'current': 5, 'total': 6, 'status': 'Î¶¨Ìè¨Ìä∏ ÌååÏùº ÏÉùÏÑ± Ï§ë...'})
        
        # Ìñ•ÏÉÅÎêú HTML ÏÉùÏÑ±
        html_content = generate_enhanced_report_html(user_name, pillars, analysis_result, elem_dict_kr)
        
        # ÌååÏùº Ï†ÄÏû• Í≤ΩÎ°ú
        output_dir = os.path.join('static', 'uploads', 'reports')
        os.makedirs(output_dir, exist_ok=True)
        html_path = os.path.join(output_dir, f'report_order_{order_id}.html')
        pdf_path = os.path.join(output_dir, f'report_order_{order_id}.pdf')
        
        # HTML Ï†ÄÏû•
        with open(html_path, 'w', encoding='utf-8') as f:
            f.write(html_content)
        logger.info(f"üìÑ HTML Ï†ÄÏû• ÏôÑÎ£å: {html_path}")
        
        # PDF ÏÉùÏÑ±
        pdf_success = html_to_pdf_improved(html_content, pdf_path)
        
        # ÌååÏùº Í≤ΩÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
        order.report_html = html_path
        if pdf_success:
            order.report_pdf = pdf_path
        db.commit()

        # Ïù¥Î©îÏùº Î∞úÏÜ°
        self.update_state(state='progress', meta={'current': 6, 'total': 6, 'status': 'Ïù¥Î©îÏùº Î∞úÏÜ° Ï§ë...'})
        
        if order.pdf_send_email:
            email_subject = f'üîÆ {user_name}ÎãòÏùò ÏÇ¨Ï£ºÌåîÏûê Ïã¨Ï∏µ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏Í∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§'
            email_body = f"""
            <h2>ÏïàÎÖïÌïòÏÑ∏Ïöî, {user_name}Îãò!</h2>
            <p>Ï£ºÎ¨∏ÌïòÏã† ÏÇ¨Ï£ºÌåîÏûê Ïã¨Ï∏µ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏Í∞Ä ÏôÑÏÑ±ÎêòÏóàÏäµÎãàÎã§.</p>
            <p>Ï≤®Î∂ÄÎêú PDF ÌååÏùºÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.</p>
            <p>Ï¢ãÏùÄ ÌïòÎ£® ÎêòÏÑ∏Ïöî! üåü</p>
            """
            
            attachments = [pdf_path] if pdf_success else []
            send_email_improved(order.pdf_send_email, email_subject, email_body, attachments)
        
        logger.info(f"üéâ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± ÏôÑÎ£å: order_id={order_id}")
        return {'status': 'SUCCESS', 'order_id': order_id, 'pdf_generated': pdf_success}
        
    except Exception as e:
        logger.error(f"üí• Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: {e}")
        db.rollback()
        raise self.retry(countdown=60, max_retries=3, exc=e)
    finally:
        db.close()

def send_email_improved(to_email: str, subject: str, body: str, attachments=None) -> bool:
    """Ïù¥Î©îÏùº Î∞úÏÜ° (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)"""
    smtp_host = os.getenv('SMTP_HOST')
    smtp_port = int(os.getenv('SMTP_PORT', '587'))
    smtp_user = os.getenv('SMTP_USER')
    smtp_password = os.getenv('SMTP_PASSWORD')

    if not all([smtp_host, smtp_user, smtp_password]):
        logger.warning('‚ö†Ô∏è SMTP ÏÑ§Ï†ïÏù¥ ÏóÜÏñ¥ Ïù¥Î©îÏùº Î∞úÏÜ°ÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§')
        return False

    try:
        msg = MIMEMultipart()
        msg['Subject'] = subject
        msg['From'] = smtp_user
        msg['To'] = to_email
        msg.attach(MIMEText(body, 'html', 'utf-8'))

        attachments = attachments or []
        for file_path in attachments:
            if os.path.exists(file_path):
                with open(file_path, 'rb') as f:
                    part = MIMEApplication(f.read(), Name=os.path.basename(file_path))
                part['Content-Disposition'] = f'attachment; filename="{os.path.basename(file_path)}"'
                msg.attach(part)

        with smtplib.SMTP(smtp_host, smtp_port) as server:
            server.starttls()
            server.login(smtp_user, smtp_password)
            server.sendmail(smtp_user, [to_email], msg.as_string())
        
        logger.info(f"üìß Ïù¥Î©îÏùº Î∞úÏÜ° ÏÑ±Í≥µ: {to_email}")
        return True
        
    except Exception as e:
        logger.error(f"üí• Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®: {e}")
        return False

# Í∏∞Ï°¥ Îã§Î•∏ ÌÉúÏä§ÌÅ¨Îì§...
@celery_app.task(name='app.tasks.cleanup_old_cache')
def cleanup_old_cache():
    """Ïò§ÎûòÎêú Ï∫êÏãú Ï†ïÎ¶¨ ÌÉúÏä§ÌÅ¨"""
    db = SessionLocal()
    try:
        cutoff_date = datetime.utcnow() - timedelta(days=30)
        old_cache = db.query(SajuAnalysisCache).filter(
            SajuAnalysisCache.created_at < cutoff_date
        ).delete()
        db.commit()
        logger.info(f"üóëÔ∏è Ïò§ÎûòÎêú Ï∫êÏãú {old_cache}Í∞ú Ï†ïÎ¶¨ ÏôÑÎ£å")
    except Exception as e:
        logger.error(f"üí• Ï∫êÏãú Ï†ïÎ¶¨ Ïã§Ìå®: {e}")
        db.rollback()
    finally:
        db.close()

@celery_app.task(bind=True, name='app.tasks.test_task')
def test_task(self, name: str):
    """ÌÖåÏä§Ìä∏Ïö© ÌÉúÏä§ÌÅ¨"""
    import time
    for i in range(5):
        time.sleep(1)
        self.update_state(state='progress', meta={'current': i+1, 'total': 5, 'status': f'Processing {name}...'})
    return {'status': 'Task completed!', 'name': name}